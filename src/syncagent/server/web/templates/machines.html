{% extends "dashboard.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-2xl font-semibold text-apple-gray-900">Machines</h1>
        <p class="mt-1 text-sm text-apple-gray-500">Connected devices syncing files</p>
    </div>

    <!-- Machines Grid -->
    {% if machines %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for machine in machines %}
        <div id="machine-card-{{ machine.id }}" class="bg-white rounded-2xl border border-apple-gray-200 p-5 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
                <div class="flex items-center gap-3">
                    <!-- Device icon based on platform -->
                    <div class="w-12 h-12 bg-apple-gray-100 rounded-xl flex items-center justify-center">
                        {% if 'windows' in machine.platform.lower() %}
                        <svg class="w-6 h-6 text-apple-blue" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 5.548l7.389-1.008v7.133H3V5.548zM3 12.673h7.389v7.132L3 18.797v-6.124zM11.389 4.389L21 3v8.673h-9.611V4.389zM11.389 12.673H21V21l-9.611-1.462v-6.865z"/>
                        </svg>
                        {% elif 'darwin' in machine.platform.lower() or 'macos' in machine.platform.lower() %}
                        <svg class="w-6 h-6 text-apple-gray-700" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                        </svg>
                        {% else %}
                        <svg class="w-6 h-6 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12.504 0c-.155 0-.311.001-.465.003-.658.014-1.316.063-1.965.167-1.304.209-2.575.644-3.69 1.324-1.116.68-2.09 1.589-2.867 2.638-.777 1.05-1.35 2.247-1.68 3.52-.165.633-.265 1.285-.302 1.944-.037.659-.007 1.333.089 1.99.191 1.315.629 2.59 1.31 3.707.68 1.118 1.593 2.096 2.648 2.875 1.054.779 2.252 1.352 3.526 1.682.636.166 1.292.267 1.953.304.33.018.663.027.994.027.331 0 .664-.009.994-.027.66-.037 1.316-.138 1.953-.304 1.274-.33 2.472-.903 3.526-1.682 1.055-.779 1.968-1.757 2.648-2.875.681-1.117 1.119-2.392 1.31-3.707.096-.657.126-1.331.089-1.99-.037-.659-.137-1.311-.302-1.944-.33-1.273-.903-2.47-1.68-3.52-.777-1.049-1.751-1.958-2.867-2.638-1.115-.68-2.386-1.115-3.69-1.324-.649-.104-1.307-.153-1.965-.167-.154-.002-.31-.003-.465-.003z"/>
                        </svg>
                        {% endif %}
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-apple-gray-900">{{ machine.name }}</h3>
                        <p class="text-xs text-apple-gray-500 capitalize">{{ machine.platform }}</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <!-- Live Status indicator (updated via WebSocket) -->
                    <div id="status-{{ machine.id }}" class="flex items-center gap-1.5">
                        {% set minutes_ago = ((now - machine.last_seen).total_seconds() / 60) | int %}
                        {% if minutes_ago < 5 %}
                        <div class="w-2 h-2 bg-green-500 rounded-full status-dot"></div>
                        <span class="text-xs text-green-600 status-text">Online</span>
                        {% else %}
                        <div class="w-2 h-2 bg-apple-gray-300 rounded-full status-dot"></div>
                        <span class="text-xs text-apple-gray-400 status-text">Offline</span>
                        {% endif %}
                    </div>

                    <!-- Dropdown menu -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" @click.outside="open = false"
                                class="p-1.5 rounded-lg text-apple-gray-400 hover:text-apple-gray-600 hover:bg-apple-gray-100 transition-colors">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                            </svg>
                        </button>
                        <div x-show="open" x-transition:enter="transition ease-out duration-100"
                             x-transition:enter-start="transform opacity-0 scale-95"
                             x-transition:enter-end="transform opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75"
                             x-transition:leave-start="transform opacity-100 scale-100"
                             x-transition:leave-end="transform opacity-0 scale-95"
                             class="absolute right-0 mt-2 w-48 bg-white rounded-xl border border-apple-gray-200 shadow-lg z-10">
                            <button @click="open = false; document.getElementById('delete-modal-{{ machine.id }}').classList.remove('hidden')"
                                    class="w-full flex items-center gap-2 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 rounded-xl transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Remove Machine
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="mt-4 pt-4 border-t border-apple-gray-100">
                <!-- Live Sync Info (updated via WebSocket) -->
                <div id="sync-info-{{ machine.id }}" class="hidden mb-3 p-2.5 bg-blue-50 rounded-lg border border-blue-100">
                    <div class="flex items-center justify-between text-xs mb-1">
                        <span class="text-blue-600 font-medium">Syncing...</span>
                        <span class="text-blue-600 sync-pending">0 pending</span>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-blue-500">
                        <span class="sync-uploads">↑ 0</span>
                        <span class="sync-downloads">↓ 0</span>
                        <span class="sync-speed">— KB/s</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-apple-gray-50 rounded-lg p-2.5 text-center">
                        <div id="file-count-{{ machine.id }}" class="text-lg font-semibold text-apple-gray-900">{{ machine_stats[machine.id].file_count }}</div>
                        <div class="text-xs text-apple-gray-500">Files</div>
                    </div>
                    <div class="bg-apple-gray-50 rounded-lg p-2.5 text-center">
                        <div id="storage-size-{{ machine.id }}" class="text-lg font-semibold text-apple-gray-900">{{ format_size(machine_stats[machine.id].total_size) }}</div>
                        <div class="text-xs text-apple-gray-500">Storage</div>
                    </div>
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="text-apple-gray-500">Last seen</span>
                    <span class="text-apple-gray-700">
                        {% if minutes_ago < 1 %}
                            Just now
                        {% elif minutes_ago < 60 %}
                            {{ minutes_ago }}m ago
                        {% elif minutes_ago < 1440 %}
                            {{ (minutes_ago / 60) | int }}h ago
                        {% else %}
                            {{ (minutes_ago / 1440) | int }}d ago
                        {% endif %}
                    </span>
                </div>
                <div class="flex items-center justify-between text-xs mt-2">
                    <span class="text-apple-gray-500">Registered</span>
                    <span class="text-apple-gray-700">{{ machine.created_at.strftime('%b %d, %Y') }}</span>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-modal-{{ machine.id }}" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
                <!-- Backdrop -->
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
                     onclick="document.getElementById('delete-modal-{{ machine.id }}').classList.add('hidden')"></div>

                <!-- Modal -->
                <div class="relative bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-lg sm:w-full">
                    <div class="bg-white px-6 py-5">
                        <div class="flex items-center gap-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-apple-gray-900">Remove Machine</h3>
                                <p class="mt-1 text-sm text-apple-gray-500">
                                    This action cannot be undone. The machine will need a new invitation to reconnect.
                                </p>
                            </div>
                        </div>

                        <div class="mt-5">
                            <label class="block text-sm font-medium text-apple-gray-700 mb-2">
                                Type <span class="font-mono bg-apple-gray-100 px-1.5 py-0.5 rounded text-red-600">{{ machine.name }}</span> to confirm
                            </label>
                            <input type="text" id="confirm-name-{{ machine.id }}"
                                   class="w-full px-4 py-2.5 border border-apple-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                   placeholder="Enter machine name"
                                   autocomplete="off">
                        </div>
                    </div>

                    <div class="bg-apple-gray-50 px-6 py-4 flex justify-end gap-3">
                        <button type="button"
                                onclick="document.getElementById('delete-modal-{{ machine.id }}').classList.add('hidden')"
                                class="px-4 py-2 text-sm font-medium text-apple-gray-700 bg-white border border-apple-gray-300 rounded-xl hover:bg-apple-gray-50 transition-colors">
                            Cancel
                        </button>
                        <form action="/machines/{{ machine.id }}/delete" method="POST" class="inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" id="delete-btn-{{ machine.id }}" disabled
                                    class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-xl hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                Remove Machine
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            (function() {
                const input = document.getElementById('confirm-name-{{ machine.id }}');
                const btn = document.getElementById('delete-btn-{{ machine.id }}');
                const expectedName = '{{ machine.name }}';

                input.addEventListener('input', function() {
                    btn.disabled = input.value !== expectedName;
                });
            })();
        </script>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty state -->
    <div class="bg-white rounded-2xl border border-apple-gray-200 px-6 py-16 text-center">
        <div class="mx-auto w-16 h-16 bg-apple-gray-100 rounded-2xl flex items-center justify-center mb-4">
            <svg class="w-8 h-8 text-apple-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
        </div>
        <h3 class="text-sm font-medium text-apple-gray-900">No machines registered</h3>
        <p class="mt-1 text-sm text-apple-gray-500 max-w-md mx-auto">
            Create an invitation to add your first machine.
        </p>
        <a href="/invitations"
           class="mt-4 inline-flex items-center px-4 py-2 bg-apple-blue text-white text-sm font-medium rounded-xl hover:bg-blue-600">
            Create Invitation
        </a>
    </div>
    {% endif %}
</div>

<!-- WebSocket Script for Real-Time Status Updates -->
<script>
(function() {
    // Connect to WebSocket for real-time status updates
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/dashboard`;
    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    const reconnectDelay = 2000;

    function formatSpeed(bytesPerSec) {
        if (bytesPerSec < 1024) return `${bytesPerSec} B/s`;
        if (bytesPerSec < 1024 * 1024) return `${(bytesPerSec / 1024).toFixed(1)} KB/s`;
        return `${(bytesPerSec / (1024 * 1024)).toFixed(1)} MB/s`;
    }

    function formatSize(bytes) {
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
        return `${(bytes / (1024 * 1024 * 1024)).toFixed(2)} GB`;
    }

    function updateMachineStatus(status) {
        const machineId = status.machine_id;
        const statusEl = document.getElementById(`status-${machineId}`);
        const syncInfoEl = document.getElementById(`sync-info-${machineId}`);
        const fileCountEl = document.getElementById(`file-count-${machineId}`);
        const storageSizeEl = document.getElementById(`storage-size-${machineId}`);

        if (!statusEl) return;

        const dot = statusEl.querySelector('.status-dot');
        const text = statusEl.querySelector('.status-text');

        // Update file stats if provided
        if (fileCountEl && status.file_count !== undefined) {
            fileCountEl.textContent = status.file_count;
        }
        if (storageSizeEl && status.total_size !== undefined) {
            storageSizeEl.textContent = formatSize(status.total_size);
        }

        // Update status indicator
        switch (status.state) {
            case 'syncing':
                dot.className = 'w-2 h-2 bg-blue-500 rounded-full status-dot animate-pulse';
                text.className = 'text-xs text-blue-600 status-text';
                text.textContent = 'Syncing';
                // Show sync info panel
                if (syncInfoEl) {
                    syncInfoEl.classList.remove('hidden');
                    syncInfoEl.querySelector('.sync-pending').textContent = `${status.files_pending} pending`;
                    syncInfoEl.querySelector('.sync-uploads').textContent = `↑ ${status.uploads_in_progress}`;
                    syncInfoEl.querySelector('.sync-downloads').textContent = `↓ ${status.downloads_in_progress}`;
                    const totalSpeed = status.upload_speed + status.download_speed;
                    syncInfoEl.querySelector('.sync-speed').textContent = formatSpeed(totalSpeed);
                }
                break;
            case 'idle':
                dot.className = 'w-2 h-2 bg-green-500 rounded-full status-dot';
                text.className = 'text-xs text-green-600 status-text';
                text.textContent = 'Online';
                if (syncInfoEl) syncInfoEl.classList.add('hidden');
                break;
            case 'error':
                dot.className = 'w-2 h-2 bg-red-500 rounded-full status-dot';
                text.className = 'text-xs text-red-600 status-text';
                text.textContent = 'Error';
                if (syncInfoEl) syncInfoEl.classList.add('hidden');
                break;
            case 'offline':
            default:
                dot.className = 'w-2 h-2 bg-apple-gray-300 rounded-full status-dot';
                text.className = 'text-xs text-apple-gray-400 status-text';
                text.textContent = 'Offline';
                if (syncInfoEl) syncInfoEl.classList.add('hidden');
                break;
        }
    }

    function connect() {
        ws = new WebSocket(wsUrl);

        ws.onopen = function() {
            console.log('Dashboard WebSocket connected');
            reconnectAttempts = 0;
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'all_status') {
                // Initial status of all machines
                data.machines.forEach(updateMachineStatus);
            } else if (data.type === 'status_update') {
                // Single machine update
                updateMachineStatus(data.machine);
            }
        };

        ws.onclose = function() {
            console.log('Dashboard WebSocket disconnected');
            // Attempt to reconnect
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(connect, reconnectDelay * reconnectAttempts);
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    }

    // Start connection
    connect();
})();
</script>
{% endblock %}
